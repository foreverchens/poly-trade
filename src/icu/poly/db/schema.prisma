// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// npx prisma db push && npx prisma generate  推送修改并执行
// npx prisma studio 打开web页面并校验

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./orders.db"
}

model Order {
  id                String   @id @default(uuid())
  eventSlug         String
  marketSlug        String

  // 订单基本信息
  side              String   // BUY / SELL
  outcome           String   // YES / NO
  orderId           String   @unique
  price             Float
  size              Float
  matched           Float    @default(0)  // 实际撮合的数量
  profit            Float    @default(0)  // 该笔订单所获取的利润

  // 关联信息 (如果是止盈单，可以关联到建仓单)
  parentOrderId     String?  // 关联的建仓单ID

  // Signal context
  tokenId           String?
  zScore            Float?
  secondsToEnd      Int?     // 下单时距离结束/开始的秒数
  priceChange       Float?   // 距离开盘价的涨跌幅
  isLiquiditySignal Boolean? @default(false)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([eventSlug])
  @@index([marketSlug])
  @@index([parentOrderId])
}


// ====================
// 主表：hour_overview
// ====================
model hour_overview {
  symbol          String   // 锚定的资产
  event_slug      String   // 涨跌事件模板的 slug
  market_slug     String   @id
  market_end_time String?  // 市场结算时间（UTC+8）
  day             Int      // 自然日（UTC+8），格式YYYYMMDD，例如20251129
  hour            Int      // 小时（UTC+8）0–23
  open_price      String   // 锚定资产现货开盘价
  close_price     String   // 锚定资产现货收盘价
  z_55            Int?     // z×10、仅一位小数、扩大10倍存储
  z_60            Int?     // z×10
  amp_55          Int?     // 百分数×100
  amp_60          Int?     // 百分数×100
  vol             Int?     // 结束时交易量、取附表最后一根数据
  create_time     DateTime @default(now())  // 入库时间

  @@index([day, hour], name: "idx_hour_overview_day_hour")
}



// =========================
// 附表：hour_minute_samples
// =========================
model hour_minute_samples {
  market_slug      String  // 对应主表的market_slug（唯一定位该小时）
  minute_idx       Int     // 1-60
  assert_price     String  // 锚定资产的USDT价格
  assert_amp       Int   @default(0)   // 资产相对于开盘价涨跌幅 百分数×100
  up_price         Int     // 概率×1000
  down_price       Int     // 概率×1000
  top_side         String  // 'UP' / 'DOWN'
  top_price        Int     // 概率×1000
  top_price_spread Int?    // 概率×1000
  top_z            Int?    // z×10
  top_vol          Int?    // 体量取整
  liq_sum          Int?    // 体量取整

  @@id([market_slug, minute_idx])
  @@index([market_slug], name: "idx_samples_market")
}

model convergence_task_config {
    slug                                     String   @id
    name                                     String
    symbol                                   String
    pk_idx                                   Int
    active                                   Boolean  @default(true)
    test                                     Boolean  @default(false)
    schedule_cron_expression                 String
    schedule_cron_timezone                   String
    schedule_tick_interval_seconds           Int
    position_size_usdc                       Float
    position_extra_size_usdc                 Float
    allow_extra_entry_at_ceiling             Boolean  @default(false)
    risk_price_trigger_gt                    Float
    risk_price_take_profit                   Float
    risk_time_max_minutes_to_end             Int
    risk_time_monitor_mode_minute_threshold  Int
    risk_statistics_z_min                    Float
    risk_statistics_amp_min                  Float
    risk_statistics_high_volatility_z_thresh Float
    risk_liquidity_sufficient_threshold      Float
    risk_spike_protection_count              Int
    create_time                              DateTime @default(now())
    creds                                    Json?
    extra                                    String   @default("")
}

