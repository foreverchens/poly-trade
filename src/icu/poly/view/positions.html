<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>Polymarket 仓位看板（最小可用）</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root { --bg:#0b0f14; --card:#121821; --muted:#9aa6b2; --text:#e6edf3; --green:#2ecc71; --red:#ff6b6b; --line:#1e2633; }
        html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
        .wrap{max-width:1080px;margin:24px auto;padding:0 16px;}
        .title{font-size:18px;margin:0 0 12px 0;}
        .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px;}
        input,button{background:#0f141c;border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:8px;}
        input{min-width:420px;flex:1 1 420px;}
        button{cursor:pointer}
        .summary{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px 12px;margin:12px 0;display:flex;gap:24px;flex-wrap:wrap}
        .summary div{opacity:.9}
        .green{color:var(--green)} .red{color:var(--red)} .muted{color:var(--muted)}
        table{width:100%;border-collapse:collapse;overflow:hidden;background:var(--card);border:1px solid var(--line);border-radius:12px;}
        thead th{font-weight:600;text-align:left;padding:10px;border-bottom:1px solid var(--line);white-space:nowrap}
        tbody td{padding:10px;border-top:1px solid var(--line);vertical-align:middle}
        .asset{display:flex;align-items:center;gap:10px;}
        .icon{width:28px;height:28px;border-radius:6px;object-fit:cover;border:1px solid var(--line)}
        .outcome{font-size:12px;color:var(--muted)}
        .right{text-align:right;white-space:nowrap}
        .footer{margin:14px 0 40px;color:var(--muted);font-size:12px}
        .tip{font-size:12px;color:var(--muted)}
        .chip{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;margin-left:6px;font-size:12px;color:var(--muted)}
        .loading{opacity:.8}
        @media (max-width:700px){
            input{min-width:240px}
            thead{display:none}
            table,tbody,tr,td{display:block;width:100%}
            tbody tr{border-top:1px solid var(--line)}
            tbody td{display:flex;justify-content:space-between;gap:12px}
            tbody td::before{content:attr(data-th);font-weight:600;color:var(--muted)}
            .asset{justify-content:flex-end}
        }
    </style>
</head>
<body>
<div class="wrap">
    <h1 class="title">Polymarket 仓位看板 <span class="chip">最小可用</span></h1>

    <div class="bar">
        <input id="addr" spellcheck="false" placeholder="输入地址（0x...）"
               value="0x864d76EE827AE3448ED327A426B6e190C5C97FA5" />
        <button id="refresh">刷新</button>
        <span id="status" class="muted"></span>
    </div>

    <div class="summary" id="summary">
        <div>持有价值：<b id="sumValue">—</b></div>
        <div>当前盈亏：<b id="sumPnl">—</b>（<span id="sumPnlPct">—</span>）</div>
        <div class="muted">仅展示 size ≥ 1 的持仓</div>
    </div>

    <table id="tbl">
        <thead>
        <tr>
            <th>资产</th>
            <th>数量</th>
            <th>成交价</th>
            <th>当前价</th>
            <th>持有价值</th>
            <th>当前盈亏</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>

    <div class="footer">
        <div class="tip">说明：持有价值按 <code>size × curPrice</code> 现场计算；盈亏使用接口返回 <code>cashPnl / percentPnl</code>，若缺失则现场推导。</div>
    </div>
</div>

<script>
    const $ = (id)=>document.getElementById(id);
    const f2 = (n)=> Number(n).toFixed(2);
    const pct = (n)=> (Number(n)*100).toFixed(2)+'%';
    const fmtMoney = (n)=> isFinite(n) ? '$'+f2(n) : '—';

    async function fetchPositions(addr){
        const url = `https://data-api.polymarket.com/positions?sizeThreshold=1&limit=100&sortBy=TOKENS&sortDirection=DESC&user=${addr}`;
        const res = await fetch(url, { mode: 'cors' });
        // 兼容：若服务端返回的是 JS 风格对象（少引号），尝试直接解析 JSON；失败则做一次“粗糙修复”
        let text = await res.text();
        try { return JSON.parse(text); }
        catch(e){
            // 粗修：给键名补引号（不严谨，但可兜底示例数据）
            const fixed = text
                .replace(/([{,\s])(\w+)\s*:/g, '$1"$2":')
                .replace(/'/g, '"');
            return JSON.parse(fixed);
        }
    }

    function render(rows){
        const tbody = $('tbody');
        tbody.innerHTML = '';

        let totalValue = 0, totalPnl = 0, totalCost = 0;

        rows.forEach(r=>{
            const title = r.title || r.slug || r.asset || '—';
            const outcome = r.outcome ? `（${r.outcome}）` : '';
            const icon = r.icon || '';
            const size = Number(r.size ?? 0);
            const avg = Number(r.avgPrice ?? 0);
            const cur = Number(r.curPrice ?? 0);
            // 现场计算持有价值与成本，用于汇总更稳妥
            const holdValue = size * cur;
            const costValue = size * avg;

            // 盈亏优先用接口给的 cashPnl/pct；没有则现场推导
            const cashPnl = isFinite(r.cashPnl) ? Number(r.cashPnl) : (holdValue - costValue);
            const percentPnl = isFinite(r.percentPnl) ? Number(r.percentPnl) : (costValue ? (cashPnl / costValue) : 0);

            totalValue += holdValue;
            totalPnl += cashPnl;
            totalCost += costValue;

            const tr = document.createElement('tr');

            tr.innerHTML = `
          <td class="asset" data-th="资产">
            ${icon ? `<img class="icon" src="${icon}" alt="">` : ''}
            <div>
              <div>${title}</div>
              <div class="outcome">${r.eventSlug ? r.eventSlug+' · ' : ''}${outcome}</div>
            </div>
          </td>
          <td class="right" data-th="数量">${size}</td>
          <td class="right" data-th="成交价">${f2(avg)}</td>
          <td class="right" data-th="当前价">${f2(cur)}</td>
          <td class="right" data-th="持有价值">${fmtMoney(holdValue)}</td>
          <td class="right" data-th="当前盈亏">
            <span class="${cashPnl>=0?'green':'red'}">${(cashPnl>=0?'+':'')+fmtMoney(cashPnl)}</span>
            <span class="${percentPnl>=0?'green':'red'}"> (${(percentPnl>=0?'+':'')+ (percentPnl*1).toFixed(2)}%)</span>
          </td>
        `;
            tbody.appendChild(tr);
        });

        $('sumValue').textContent = fmtMoney(totalValue);
        const pnlPct = totalCost ? (totalPnl/totalCost) : 0;
        $('sumPnl').innerHTML = `<span class="${totalPnl>=0?'green':'red'}">${(totalPnl>=0?'+':'')+fmtMoney(totalPnl)}</span>`;
        $('sumPnlPct').innerHTML = `<span class="${pnlPct>=0?'green':'red'}">${(pnlPct*100).toFixed(2)}%</span>`;
    }

    async function load(){
        const addr = $('addr').value.trim();
        if(!addr || !addr.startsWith('0x') || addr.length<10){
            alert('请输入有效的钱包地址（0x...）'); return;
        }
        const st = $('status');
        st.textContent = '加载中…';
        st.classList.add('loading');
        try{
            const rows = await fetchPositions(addr);
            render(Array.isArray(rows)? rows : []);
            st.textContent = `已加载 ${Array.isArray(rows)? rows.length:0} 条持仓`;
        }catch(err){
            console.error(err);
            st.textContent = '加载失败（请检查网络/CORS 或稍后重试）';
        }finally{
            st.classList.remove('loading');
        }
    }

    $('refresh').addEventListener('click', load);
    // 首次自动加载
    load();
</script>
</body>
</html>
